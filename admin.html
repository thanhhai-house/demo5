<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--panel:rgba(255,255,255,.035);--line:rgba(255,255,255,.10);--text:#eaf0ff;--muted:#9bb0d0;--accent:#4da3ff;--danger:#ff557a;--radius:18px;--shadow:0 12px 30px rgba(0,0,0,.35);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,#050812,#0b1220 50%,#050812);}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;padding:14px 16px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
    .brand{display:flex;gap:10px;align-items:center;font-weight:900}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px rgba(77,163,255,.55)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);cursor:pointer}
    .btn.primary{border-color:rgba(77,163,255,.45);background:rgba(77,163,255,.12)}
    .btn.danger{border-color:rgba(255,85,122,.45);background:rgba(255,85,122,.10)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
    input,select,textarea{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);outline:none}
    textarea{min-height:110px;resize:vertical}
    .panel{margin-top:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);overflow:hidden;box-shadow:var(--shadow)}
    .panelHead{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .panelBody{padding:14px}
    .split{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:rgba(255,255,255,.03);overflow:hidden}
    .pad{padding:12px}
    .name{font-weight:800}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    @media(max-width:820px){.split{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand"><div class="dot"></div><span>CATALOG</span> <span class="pill">ADMIN</span></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a class="btn primary" href="./index.html">â¬… Home</a>
      <button class="btn" id="reloadBtn">ğŸ”„ Táº£i danh sÃ¡ch</button>
      <button class="btn" id="newBtn">â• ThÃªm má»›i</button>
    </div>
  </div>

  <div class="panel">
    <div class="panelHead">
      <div class="row">
        <span class="pill" id="statePill">chÆ°a Ä‘Äƒng nháº­p</span>
        <input id="token" placeholder="ADMIN_TOKEN" style="max-width:260px"/>
        <button class="btn primary" id="saveTokenBtn">ğŸ” LÆ°u token</button>
        <button class="btn" id="logoutBtn">ğŸšª Logout</button>
      </div>
      <div class="row">
        <button class="btn" id="exportBtn">â¬‡ Export Excel</button>
        <label class="btn" style="cursor:pointer">â¬† Import Excel
          <input id="importFile" type="file" accept=".xlsx,.xls" style="display:none">
        </label>
        <button class="btn" id="tplBtn">ğŸ“„ Template</button>
        <span class="pill" id="countPill">0</span>
      </div>
    </div>

    <div class="panelBody">
      <div class="split">
        <div class="card">
          <div class="pad">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">Danh sÃ¡ch</h3>
              <input id="filter" placeholder="lá»c nhanh..." style="max-width:260px"/>
            </div>
            <div id="list" style="margin-top:10px;display:grid;gap:10px"></div>
          </div>
        </div>

        <div class="card">
          <div class="pad">
            <h3 style="margin:0 0 10px">Form</h3>

            <div class="row">
              <input id="f_id" placeholder="id (auto)" disabled />
              <input id="f_status" placeholder="status: active/hidden" />
            </div>

            <div class="row" style="margin-top:10px">
              <input id="f_sku" placeholder="SKU (báº¯t buá»™c)" />
              <input id="f_name" placeholder="TÃªn (báº¯t buá»™c)" />
            </div>

            <div class="row" style="margin-top:10px">
              <input id="f_slug" placeholder="Slug (Ä‘á»ƒ trá»‘ng tá»± táº¡o)" />
              <input id="f_brand" placeholder="Brand" />
            </div>

            <div class="row" style="margin-top:10px">
              <input id="f_category" placeholder="Category" />
              <input id="f_tags" placeholder="Tags: a,b,c" />
            </div>

            <div class="row" style="margin-top:10px">
              <input id="f_price" placeholder="Price (number)" />
              <input id="f_stock" placeholder="Stock (number)" />
            </div>

            <div style="margin-top:10px">
              <div class="row" style="justify-content:space-between">
                <input id="f_images" placeholder="Images URLs, ngÄƒn báº±ng |" />
                <label class="btn primary" style="cursor:pointer;white-space:nowrap">â¬† Upload áº£nh
                  <input id="imgUpload" type="file" accept="image/*" style="display:none">
                </label>
              </div>
              <div class="muted small" style="margin-top:6px">Upload â†’ Drive folder â†’ tá»± láº¥y link vÃ  thÃªm vÃ o Images.</div>
            </div>

            <div style="margin-top:10px"><input id="f_short" placeholder="Short description" /></div>
            <div style="margin-top:10px"><textarea id="f_desc" placeholder="desc_html (HTML allowed)"></textarea></div>
            <div style="margin-top:10px"><textarea id="f_specs" placeholder='specs_json (JSON) vÃ­ dá»¥: {"Ren":"3/4-16"}'></textarea></div>

            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="saveBtn">ğŸ’¾ LÆ°u</button>
              <button class="btn danger" id="delBtn">ğŸ—‘ XÃ³a</button>
              <a class="btn" id="previewBtn" href="#" target="_blank">ğŸ‘ Preview</a>
            </div>

            <div class="muted small" id="msg" style="margin-top:10px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxKVhD31siOzKUf0Apk8AS0qInEujEpApw-vlM6A-SWQmqMIYtv8UR7ia4EINyY6nb7pg/exec";
const $ = (id)=>document.getElementById(id);
const state = { token: localStorage.getItem("ADMIN_TOKEN")||"", items:[] };

async function apiGet(params){
  const url = API_URL + "?" + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return await res.json();
}
async function apiPost(action, token, body){
  const url = API_URL + "?" + new URLSearchParams({action, token}).toString();
  const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
  return await res.json();
}
function setStatePill(){
  $("statePill").textContent = state.token ? "Ä‘Ã£ cÃ³ token" : "chÆ°a Ä‘Äƒng nháº­p";
}
function setMsg(m){ $("msg").textContent = m||""; }

function newForm(){
  $("f_id").value=""; $("f_status").value="active";
  $("f_sku").value=""; $("f_name").value=""; $("f_slug").value="";
  $("f_brand").value=""; $("f_category").value=""; $("f_tags").value="";
  $("f_price").value="0"; $("f_stock").value="0";
  $("f_images").value=""; $("f_short").value="";
  $("f_desc").value=""; $("f_specs").value="{}";
  $("previewBtn").href="#";
  setMsg("Äang táº¡o má»›i...");
}
function fillForm(p){
  $("f_id").value=p.id||""; $("f_status").value=p.status||"active";
  $("f_sku").value=p.sku||""; $("f_name").value=p.name||""; $("f_slug").value=p.slug||"";
  $("f_brand").value=p.brand||""; $("f_category").value=p.category||""; $("f_tags").value=p.tags||"";
  $("f_price").value=String(p.price||0); $("f_stock").value=String(p.stock||0);
  $("f_images").value=(p.images||[]).join("|");
  $("f_short").value=p.short_desc||"";
  $("f_desc").value=p.desc_html||"";
  $("f_specs").value=p.specs_json||"{}";
  $("previewBtn").href = "./product.html?slug=" + encodeURIComponent(p.slug||"");
  setMsg("Äang sá»­a: "+(p.slug||""));
}
function readForm(){
  return {
    id:$("f_id").value.trim(),
    status:$("f_status").value.trim()||"active",
    sku:$("f_sku").value.trim(),
    name:$("f_name").value.trim(),
    slug:$("f_slug").value.trim(),
    brand:$("f_brand").value.trim(),
    category:$("f_category").value.trim(),
    tags:$("f_tags").value.trim(),
    price:Number($("f_price").value||0),
    stock:Number($("f_stock").value||0),
    images:$("f_images").value.trim(),
    short_desc:$("f_short").value.trim(),
    desc_html:$("f_desc").value,
    specs_json:$("f_specs").value.trim()||"{}"
  };
}
function renderList(items){
  $("countPill").textContent = String(items.length);
  $("list").innerHTML = items.map(p=>`
    <div class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">${String(p.name||"")}</div>
            <div class="muted small">${String(p.sku||"")} â€¢ ${String(p.slug||"")} â€¢ ${String(p.status||"")}</div>
          </div>
          <div class="row">
            <button class="btn" data-edit="${p.id}">âœï¸</button>
            <a class="btn" href="./product.html?slug=${encodeURIComponent(p.slug||"")}" target="_blank">ğŸ‘</a>
          </div>
        </div>
      </div>
    </div>
  `).join("");

  document.querySelectorAll("[data-edit]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id=b.getAttribute("data-edit");
      const p=state.items.find(x=>String(x.id)===String(id));
      if(p) fillForm(p);
    });
  });
}
async function loadAdmin(){
  if(!state.token){ setMsg("ChÆ°a cÃ³ token"); return; }
  const d = await apiGet({action:"admin_list", token:state.token});
  if(!d.ok){ setMsg(d.error||"Lá»—i"); return; }
  state.items = d.items||[];
  renderList(state.items);
  setMsg("ÄÃ£ táº£i");
}
async function saveOne(){
  if(!state.token){ setMsg("ChÆ°a cÃ³ token"); return; }
  const p = readForm();
  if(!p.sku || !p.name){ setMsg("Thiáº¿u SKU/TÃªn"); return; }
  try{ JSON.parse(p.specs_json||"{}"); }catch(e){ setMsg("specs_json sai JSON"); return; }
  const d = await apiPost("upsert", state.token, {product:p});
  if(!d.ok){ setMsg(d.error||"Lá»—i lÆ°u"); return; }
  setMsg(`OK: ${d.mode} â€¢ slug=${d.slug}`);
  await loadAdmin();
  if(d.slug) $("f_slug").value=d.slug;
  $("previewBtn").href = "./product.html?slug=" + encodeURIComponent(d.slug||$("f_slug").value);
}
async function delOne(){
  if(!state.token){ setMsg("ChÆ°a cÃ³ token"); return; }
  const id=$("f_id").value.trim();
  const slug=$("f_slug").value.trim();
  if(!id && !slug){ setMsg("Chá»n sáº£n pháº©m Ä‘á»ƒ xÃ³a"); return; }
  const d = await apiGet({action:"delete", token:state.token, id, slug});
  if(!d.ok){ setMsg(d.error||"Lá»—i xÃ³a"); return; }
  setMsg("ÄÃ£ xÃ³a");
  newForm();
  await loadAdmin();
}

/** upload image -> drive */
function fileToBase64Raw(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=>{
      const s = String(r.result||"");
      const idx = s.indexOf("base64,");
      resolve(idx>=0 ? s.slice(idx+7) : s);
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
$("imgUpload").addEventListener("change", async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  if(!state.token){ setMsg("ChÆ°a cÃ³ token"); return; }
  setMsg("Äang upload áº£nh...");
  const base64 = await fileToBase64Raw(file);
  const d = await apiPost("upload_image", state.token, { filename:file.name, mimeType:file.type||"image/jpeg", base64 });
  if(!d.ok){ setMsg(d.error||"Upload lá»—i"); return; }
  const cur = $("f_images").value.trim();
  $("f_images").value = cur ? (cur + "|" + d.url) : d.url;
  setMsg("Upload xong, Ä‘Ã£ thÃªm link");
  ev.target.value="";
});

/** Excel */
function downloadTemplate(){
  const headers=["id","slug","sku","name","brand","category","tags","short_desc","desc_html","specs_json","images","price","stock","status"];
  const ws=XLSX.utils.aoa_to_sheet([headers]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "template");
  XLSX.writeFile(wb, "products_template.xlsx");
}
function exportExcel(){
  if(!state.items.length){ setMsg("ChÆ°a cÃ³ dá»¯ liá»‡u"); return; }
  const headers=["id","slug","sku","name","brand","category","tags","short_desc","desc_html","specs_json","images","price","stock","status","created_at","updated_at"];
  const rows=state.items.map(p=>[
    p.id||"", p.slug||"", p.sku||"", p.name||"", p.brand||"", p.category||"", p.tags||"",
    p.short_desc||"", p.desc_html||"", p.specs_json||"", (p.images||[]).join("|"),
    Number(p.price||0), Number(p.stock||0), p.status||"active", p.created_at||"", p.updated_at||""
  ]);
  const ws=XLSX.utils.aoa_to_sheet([headers,...rows]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "products");
  XLSX.writeFile(wb, "products_export.xlsx");
}
function readXlsx(file){
  return new Promise((resolve, reject)=>{
    const r=new FileReader();
    r.onload=(e)=>{ try{ resolve(XLSX.read(new Uint8Array(e.target.result), {type:"array"})); }catch(err){ reject(err);} };
    r.onerror=reject;
    r.readAsArrayBuffer(file);
  });
}
$("importFile").addEventListener("change", async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  if(!state.token){ setMsg("ChÆ°a cÃ³ token"); return; }

  try{
    setMsg("Äang Ä‘á»c Excel...");
    const wb = await readXlsx(file);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {defval:"", raw:false});

    const items = rows.map(r=>({
      id:String(r.id||"").trim(),
      slug:String(r.slug||"").trim(),
      sku:String(r.sku||"").trim(),
      name:String(r.name||"").trim(),
      brand:String(r.brand||"").trim(),
      category:String(r.category||"").trim(),
      tags:String(r.tags||"").trim(),
      short_desc:String(r.short_desc||"").trim(),
      desc_html:String(r.desc_html||""),
      specs_json:String(r.specs_json||"{}").trim()||"{}",
      images:String(r.images||"").trim(),
      price:Number(r.price||0),
      stock:Number(r.stock||0),
      status:String(r.status||"active").trim()||"active"
    }));

    setMsg("Äang import...");
    const d = await apiPost("batch_upsert", state.token, {items});
    if(!d.ok){ setMsg(d.error||"Import lá»—i"); return; }
    setMsg(`Import OK: created=${d.created}, updated=${d.updated}, skipped=${d.skipped}, errors=${(d.errors||[]).length}`);
    await loadAdmin();
  }catch(err){
    setMsg("Import lá»—i: "+String(err));
  }finally{
    ev.target.value="";
  }
});

/** wiring */
$("saveTokenBtn").addEventListener("click", ()=>{
  state.token = $("token").value.trim();
  localStorage.setItem("ADMIN_TOKEN", state.token);
  setStatePill();
  setMsg("ÄÃ£ lÆ°u token");
});
$("logoutBtn").addEventListener("click", ()=>{
  state.token=""; localStorage.removeItem("ADMIN_TOKEN");
  $("token").value=""; setStatePill(); setMsg("ÄÃ£ logout");
});
$("reloadBtn").addEventListener("click", loadAdmin);
$("newBtn").addEventListener("click", newForm);
$("saveBtn").addEventListener("click", saveOne);
$("delBtn").addEventListener("click", delOne);

$("filter").addEventListener("input", ()=>{
  const q=$("filter").value.trim().toLowerCase();
  const items = state.items.filter(p=>{
    const hay=[p.name,p.sku,p.slug].map(x=>String(x||"").toLowerCase()).join(" | ");
    return !q || hay.includes(q);
  });
  renderList(items);
});

$("exportBtn").addEventListener("click", exportExcel);
$("tplBtn").addEventListener("click", downloadTemplate);

(async function(){
  $("token").value = state.token;
  setStatePill();
  newForm();
  if(!API_URL.includes("script.google.com")) setMsg("Báº¡n chÆ°a dÃ¡n API_URL");
})();
</script>
</body>
</html>
