<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Catalog</title>
  <style>
    :root{
      --bg:#070b14;--panel:rgba(255,255,255,.035);--line:rgba(255,255,255,.10);
      --text:#eaf0ff;--muted:#9bb0d0;--accent:#4da3ff;--radius:18px;--shadow:0 12px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(77,163,255,.20), transparent 60%),
        radial-gradient(900px 500px at 100% 10%, rgba(255,85,122,.16), transparent 55%),
        linear-gradient(180deg,#050812,#0b1220 50%,#050812);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:var(--panel);border:1px solid var(--line);
      border-radius:16px;backdrop-filter: blur(10px);box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.4px}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px rgba(77,163,255,.55)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);cursor:pointer;color:var(--text);
      transition:.15s transform,.15s border-color;
    }
    .btn:hover{border-color:rgba(255,255,255,.18);transform:translateY(-1px)}
    .btn.primary{border-color:rgba(77,163,255,.45);background:rgba(77,163,255,.12)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .controls{margin-top:16px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px}
    input,select{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--text);outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);overflow:hidden;box-shadow: var(--shadow)}
    .img{aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;background:#0a1020}
    .img img{max-width:100%;max-height:100%;object-fit:contain}
    .pad{padding:12px 12px 14px}
    .name{font-weight:800;line-height:1.2}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0a1020;border:1px solid var(--line);padding:10px 12px;border-radius:12px;
      display:none;max-width:92vw;box-shadow: var(--shadow)
    }
    @media(max-width:1050px){.grid{grid-template-columns:repeat(3,1fr)}.controls{grid-template-columns:1fr 1fr}}
    @media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div><span id="siteName">CATALOG</span>
      <span class="pill">HOME</span>
    </div>
    <div class="actions">
      <a class="btn" id="contactBtn" href="#" target="_blank">üí¨ Li√™n h·ªá</a>
      <a class="btn" href="./admin.html">üõ† Admin</a>
      <a class="btn primary" href="./index.html">üè† Home</a>
    </div>
  </div>

  <div class="controls">
    <input id="q" placeholder="T√¨m theo t√™n / SKU / tag..." />
    <select id="category"></select>
    <select id="brand"></select>
    <select id="sort">
      <option value="updated_desc">M·ªõi c·∫≠p nh·∫≠t</option>
      <option value="name_asc">T√™n A‚ÜíZ</option>
      <option value="price_asc">Gi√° tƒÉng</option>
      <option value="price_desc">Gi√° gi·∫£m</option>
    </select>
  </div>

  <div class="row" style="margin-top:10px;justify-content:space-between">
    <div class="row">
      <span class="pill" id="countPill">0 s·∫£n ph·∫©m</span>
      <span class="pill" id="filterPill">l·ªçc: none</span>
    </div>
    <div class="row">
      <button class="btn" id="prevBtn">‚Üê</button>
      <span class="pill" id="pagePill">Trang 1</span>
      <button class="btn" id="nextBtn">‚Üí</button>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  IMPORTANT: PUT YOUR API URL HERE
 *  ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxKVhD31siOzKUf0Apk8AS0qInEujEpApw-vlM6A-SWQmqMIYtv8UR7ia4EINyY6nb7pg/exec";

/** ========================= */
const $ = (id)=>document.getElementById(id);
const state = { site:{site_name:"CATALOG",contact_url:"#",currency:"VND"}, page:1, limit:12, total:0 };

function toast(msg){
  const t=$("toast"); t.textContent=msg; t.style.display="block";
  clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display="none",2200);
}
function fmtMoney(v){
  v = Number(v||0);
  if(state.site.currency==="VND") return v.toLocaleString("vi-VN")+" ‚Ç´";
  return v.toLocaleString()+" "+(state.site.currency||"");
}
async function apiGet(params){
  const url = API_URL + "?" + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return await res.json();
}
function buildSelect(selectEl, items, placeholder){
  selectEl.innerHTML = "";
  const o0=document.createElement("option"); o0.value=""; o0.textContent=placeholder; selectEl.appendChild(o0);
  items.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; selectEl.appendChild(o); });
}
function cardHtml(p){
  const href = "./product.html?slug=" + encodeURIComponent(p.slug);
  return `
    <a class="card" href="${href}">
      <div class="img">${p.image?`<img src="${p.image}" alt="">`:""}</div>
      <div class="pad">
        <div class="name">${String(p.name||"")}</div>
        <div class="muted small" style="margin-top:6px">${String(p.sku||"")} ‚Ä¢ ${String(p.brand||"")}</div>
        <div class="muted small" style="margin-top:6px">${String(p.short_desc||"")}</div>
        <div class="row" style="margin-top:10px;justify-content:space-between">
          <span class="pill">${fmtMoney(p.price||0)}</span>
          <span class="pill">Stock: ${Number(p.stock||0)}</span>
        </div>
      </div>
    </a>`;
}
function renderGrid(items){ $("grid").innerHTML = (items||[]).map(cardHtml).join(""); }

async function bootstrapSite(){
  const s = await apiGet({action:"site"});
  if(s.ok) state.site = s.site;
  $("siteName").textContent = state.site.site_name || "CATALOG";
  $("contactBtn").href = state.site.contact_url || "#";

  // build filters from first 30 items
  const d = await apiGet({action:"list", page:1, limit:30, sort:"updated_desc"});
  if(!d.ok) return;
  const cats=new Set(), brands=new Set();
  (d.items||[]).forEach(p=>{ if(p.category) cats.add(p.category); if(p.brand) brands.add(p.brand); });
  buildSelect($("category"), Array.from(cats).sort(), "Category");
  buildSelect($("brand"), Array.from(brands).sort(), "Brand");
}

async function loadHome(){
  const q = $("q").value.trim();
  const category = $("category").value.trim();
  const brand = $("brand").value.trim();
  const sort = $("sort").value;

  if(q){
    const d = await apiGet({action:"search", q});
    if(!d.ok){ toast("L·ªói search"); return; }
    $("countPill").textContent = `${(d.items||[]).length} s·∫£n ph·∫©m`;
    $("filterPill").textContent = `l·ªçc: q="${q}"`;
    $("pagePill").textContent = "Search";
    renderGrid(d.items||[]);
    return;
  }

  const params = {action:"list", page:state.page, limit:state.limit, sort};
  if(category) params.category=category;
  if(brand) params.brand=brand;

  const d = await apiGet(params);
  if(!d.ok){ toast("L·ªói list"); return; }

  state.total = d.total||0;
  const maxPage = Math.max(1, Math.ceil(state.total/state.limit));
  $("countPill").textContent = `${state.total} s·∫£n ph·∫©m`;
  $("pagePill").textContent = `Trang ${state.page}/${maxPage}`;

  const f=[]; if(category) f.push("cat="+category); if(brand) f.push("brand="+brand);
  $("filterPill").textContent = "l·ªçc: " + (f.length?f.join(", "):"none");
  renderGrid(d.items||[]);
}

function wire(){
  let t;
  ["q","category","brand","sort"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ clearTimeout(t); t=setTimeout(()=>{state.page=1;loadHome();},260); });
    $(id).addEventListener("change", ()=>{ state.page=1; loadHome(); });
  });
  $("prevBtn").addEventListener("click", ()=>{ state.page=Math.max(1,state.page-1); loadHome(); });
  $("nextBtn").addEventListener("click", ()=>{
    const maxPage=Math.max(1,Math.ceil(state.total/state.limit));
    state.page=Math.min(maxPage,state.page+1); loadHome();
  });
}

(async function(){
  if(!API_URL.includes("script.google.com")) toast("B·∫°n ch∆∞a d√°n API_URL");
  await bootstrapSite();
  wire();
  await loadHome();
})();
</script>
</body>
</html>
