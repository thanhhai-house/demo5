<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catalog</title>

  <!-- Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --panel:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:#9bb0d0;
      --accent:#4da3ff;
      --danger:#ff557a;
      --ok:#39d98a;
      --radius:18px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(77,163,255,.20), transparent 60%),
        radial-gradient(900px 500px at 100% 10%, rgba(255,85,122,.16), transparent 55%),
        linear-gradient(180deg,#050812,#0b1220 50%,#050812);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:var(--panel);border:1px solid var(--line);
      border-radius:16px;backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.4px}
    .brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px rgba(77,163,255,.55)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);cursor:pointer;color:var(--text);
      transition:.15s transform,.15s border-color;
    }
    .btn:hover{border-color:rgba(255,255,255,.18);transform:translateY(-1px)}
    .btn.primary{border-color:rgba(77,163,255,.45);background:rgba(77,163,255,.12)}
    .btn.danger{border-color:rgba(255,85,122,.45);background:rgba(255,85,122,.10)}
    .pill{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted);font-size:12px
    }
    .controls{
      margin-top:16px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px
    }
    input,select,textarea{
      width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--text);outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .card{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);overflow:hidden;box-shadow: var(--shadow)}
    .img{aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;background:#0a1020}
    .img img{max-width:100%;max-height:100%;object-fit:contain}
    .pad{padding:12px 12px 14px}
    .name{font-weight:800;line-height:1.2}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .panel{margin-top:16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);overflow:hidden;box-shadow: var(--shadow)}
    .panelHead{
      padding:12px 14px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
    }
    .panelBody{padding:14px}
    .split{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
    .hero{aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;background:#0a1020;border-bottom:1px solid var(--line)}
    .hero img{max-width:100%;max-height:100%;object-fit:contain}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap;padding:12px}
    .thumb{width:72px;height:72px;border-radius:14px;border:1px solid var(--line);background:#0a1020;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .thumb img{max-width:92%;max-height:92%;object-fit:contain}
    .tabs{display:flex;gap:10px;border-bottom:1px solid var(--line);padding:0 14px;margin-top:10px}
    .tab{padding:12px 8px;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{color:var(--text);border-bottom-color:var(--accent)}
    table{width:100%;border-collapse:collapse}
    td{padding:10px 8px;border-bottom:1px solid var(--line);color:var(--muted)}
    td:first-child{color:var(--text);width:45%}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0a1020;border:1px solid var(--line);
      padding:10px 12px;border-radius:12px;color:var(--text);
      display:none;max-width:92vw;box-shadow: var(--shadow)
    }
    .hide{display:none !important}
    @media(max-width:1050px){.grid{grid-template-columns:repeat(3,1fr)}.controls{grid-template-columns:1fr 1fr}}
    @media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}.split{grid-template-columns:1fr}}
    @media(max-width:520px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand" onclick="go('#/')" style="cursor:pointer">
      <div class="dot"></div><span id="siteName">CATALOG</span>
      <span class="pill" id="envPill">home</span>
    </div>
    <div class="actions">
      <button class="btn" id="contactBtn" onclick="openContact()">üí¨ Li√™n h·ªá</button>
      <button class="btn" onclick="go('#/admin')">üõ† Admin</button>
      <button class="btn primary" onclick="go('#/')">üè† Home</button>
    </div>
  </div>

  <!-- HOME -->
  <div id="route_home">
    <div class="controls">
      <input id="q" placeholder="T√¨m theo t√™n / SKU / tag..." />
      <select id="category"></select>
      <select id="brand"></select>
      <select id="sort">
        <option value="updated_desc">M·ªõi c·∫≠p nh·∫≠t</option>
        <option value="name_asc">T√™n A‚ÜíZ</option>
        <option value="price_asc">Gi√° tƒÉng</option>
        <option value="price_desc">Gi√° gi·∫£m</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px;justify-content:space-between">
      <div class="row">
        <span class="pill" id="countPill">0 s·∫£n ph·∫©m</span>
        <span class="pill" id="filterPill">l·ªçc: none</span>
      </div>
      <div class="row">
        <button class="btn" onclick="prevPage()">‚Üê</button>
        <span class="pill" id="pagePill">Trang 1</span>
        <button class="btn" onclick="nextPage()">‚Üí</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- DETAIL -->
  <div id="route_detail" class="hide">
    <div class="panel">
      <div class="panelHead">
        <span class="pill" id="crumb">Trang ch·ªß / ...</span>
        <div class="row">
          <button class="btn" onclick="copyLink()">üîó Copy link</button>
          <button class="btn primary" onclick="go('#/')">‚¨Ö Quay l·∫°i</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="split">
          <div class="card">
            <div class="hero" id="hero"></div>
            <div class="thumbs" id="thumbs"></div>
          </div>

          <div class="card">
            <div class="pad">
              <div class="row" style="justify-content:space-between">
                <h2 id="d_name" style="margin:0;font-size:22px"></h2>
                <span class="pill" id="d_status"></span>
              </div>
              <div class="muted small" id="d_meta"></div>
              <p class="muted" id="d_short"></p>

              <div class="row" style="margin-top:10px">
                <span class="pill" id="d_price"></span>
                <span class="pill" id="d_stock"></span>
                <span class="pill" id="d_updated"></span>
              </div>

              <div class="tabs">
                <div class="tab active" data-tab="desc">M√¥ t·∫£</div>
                <div class="tab" data-tab="spec">Th√¥ng s·ªë</div>
                <div class="tab" data-tab="rel">Li√™n quan</div>
              </div>

              <div id="tab_desc" style="padding:12px 14px"></div>
              <div id="tab_spec" style="padding:12px 14px;display:none"></div>
              <div id="tab_rel" style="padding:12px 14px;display:none">
                <div class="grid" id="relGrid" style="margin-top:0"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="route_admin" class="hide">
    <div class="panel">
      <div class="panelHead">
        <div class="row">
          <span class="pill">Admin</span>
          <span class="pill" id="adminState">ch∆∞a ƒëƒÉng nh·∫≠p</span>
        </div>
        <div class="row">
          <button class="btn" onclick="adminLogout()">üö™ Logout</button>
          <button class="btn primary" onclick="adminLoad()">üîÑ T·∫£i danh s√°ch</button>
          <button class="btn" onclick="newForm()">‚ûï Th√™m m·ªõi</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <input id="adminToken" placeholder="ADMIN_TOKEN (l∆∞u local)" style="max-width:320px" />
          <button class="btn primary" onclick="adminLogin()">üîê Login</button>
          <span class="muted small">Token l∆∞u trong tr√¨nh duy·ªát.</span>
        </div>

        <div class="row" style="margin-top:12px;justify-content:space-between">
          <div class="row">
            <button class="btn" onclick="exportExcel()">‚¨á Export Excel</button>
            <label class="btn" style="cursor:pointer">
              ‚¨Ü Import Excel
              <input id="importFile" type="file" accept=".xlsx,.xls" style="display:none" />
            </label>
            <button class="btn" onclick="downloadTemplate()">üìÑ T·∫£i template</button>
          </div>
          <span class="pill" id="adminCount">0 s·∫£n ph·∫©m</span>
        </div>

        <div class="split" style="margin-top:14px">
          <div class="card">
            <div class="pad">
              <h3 style="margin:0 0 10px">Danh s√°ch</h3>
              <input id="adminFilter" placeholder="l·ªçc nhanh (name/sku/slug)" />
              <div id="adminList" style="margin-top:10px;display:grid;gap:10px"></div>
            </div>
          </div>

          <div class="card">
            <div class="pad">
              <h3 style="margin:0 0 10px">Form s·∫£n ph·∫©m</h3>

              <div class="row">
                <input id="f_id" placeholder="id (auto)" disabled />
                <input id="f_status" placeholder="status: active/hidden" />
              </div>

              <div class="row" style="margin-top:10px">
                <input id="f_sku" placeholder="SKU (b·∫Øt bu·ªôc)" />
                <input id="f_name" placeholder="T√™n (b·∫Øt bu·ªôc)" />
              </div>

              <div class="row" style="margin-top:10px">
                <input id="f_slug" placeholder="Slug (ƒë·ªÉ tr·ªëng t·ª± t·∫°o)" />
                <input id="f_brand" placeholder="Brand" />
              </div>

              <div class="row" style="margin-top:10px">
                <input id="f_category" placeholder="Category" />
                <input id="f_tags" placeholder="Tags: a,b,c" />
              </div>

              <div class="row" style="margin-top:10px">
                <input id="f_price" placeholder="Price (number)" />
                <input id="f_stock" placeholder="Stock (number)" />
              </div>

              <div style="margin-top:10px">
                <div class="row" style="justify-content:space-between">
                  <input id="f_images" placeholder="Images URLs, ngƒÉn b·∫±ng |" />
                  <label class="btn primary" style="cursor:pointer;white-space:nowrap">
                    ‚¨Ü Upload ·∫£nh
                    <input id="imgUpload" type="file" accept="image/*" style="display:none" />
                  </label>
                </div>
                <div class="muted small" style="margin-top:6px">
                  Upload ·∫£nh s·∫Ω t·ª± th√™m link Drive v√†o √¥ Images.
                </div>
              </div>

              <div style="margin-top:10px">
                <input id="f_short" placeholder="Short description" />
              </div>

              <div style="margin-top:10px">
                <textarea id="f_desc" placeholder="desc_html (HTML allowed)"></textarea>
              </div>

              <div style="margin-top:10px">
                <textarea id="f_specs" placeholder='specs_json (JSON object) v√≠ d·ª•: {"Ren":"3/4-16"}'></textarea>
              </div>

              <div class="row" style="margin-top:12px">
                <button class="btn primary" onclick="saveProduct()">üíæ L∆∞u</button>
                <button class="btn danger" onclick="deleteProduct()">üóë X√≥a</button>
                <button class="btn" onclick="previewProduct()">üëÅ Preview</button>
              </div>

              <div class="muted small" id="adminMsg" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script src="./config.js"></script>
<script>
/** =========================
 *  CONFIG
 *  ========================= */
const API = window.APP_CONFIG?.API_URL || "";
const state = {
  site: {site_name:"CATALOG", contact_url:"https://zalo.me/", currency:"VND"},
  page: 1,
  limit: 12,
  total: 0,
  lastList: [],
  lastDetail: null,
  adminToken: localStorage.getItem("ADMIN_TOKEN") || ""
};

function $(id){ return document.getElementById(id); }
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>t.style.display="none", 2400);
}
function go(hash){ location.hash = hash; }
function openContact(){ window.open(state.site.contact_url, "_blank"); }
function fmtMoney(v){
  v = Number(v||0);
  if(state.site.currency === "VND") return v.toLocaleString("vi-VN") + " ‚Ç´";
  return v.toLocaleString() + " " + (state.site.currency||"");
}
function setMetaTitle(title){
  document.title = title ? (title + " | " + state.site.site_name) : state.site.site_name;
}
function setHero(src){
  const hero = $("hero");
  hero.innerHTML = src ? `<img src="${src}" alt="">` : `<div class="muted">Kh√¥ng c√≥ ·∫£nh</div>`;
}

async function apiGet(params){
  const url = API + "?" + new URLSearchParams(params).toString();
  const res = await fetch(url);
  return await res.json();
}
async function apiPost(action, token, body){
  const url = API + "?" + new URLSearchParams({action, token}).toString();
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body || {})
  });
  return await res.json();
}

async function loadSite(){
  const data = await apiGet({action:"site"});
  if(data.ok) state.site = data.site;
  $("siteName").textContent = state.site.site_name || "CATALOG";
}

function buildSelectOptions(selectEl, items, placeholder){
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.innerHTML = "";
  selectEl.appendChild(opt0);
  items.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  });
}

async function homeBootstrapFilters(){
  if(homeBootstrapFilters._done) return;
  homeBootstrapFilters._done = true;

  const data = await apiGet({action:"list", page:1, limit:30, sort:"updated_desc"});
  if(!data.ok) return;

  const cats = new Set();
  const brands = new Set();
  (data.items||[]).forEach(p=>{
    if(p.category) cats.add(p.category);
    if(p.brand) brands.add(p.brand);
  });
  buildSelectOptions($("category"), Array.from(cats).sort(), "Category");
  buildSelectOptions($("brand"), Array.from(brands).sort(), "Brand");
}

function renderGrid(items){
  const grid = $("grid");
  grid.innerHTML = (items||[]).map(p=>`
    <a class="card" href="#/p/${encodeURIComponent(p.slug)}">
      <div class="img">${p.image ? `<img src="${p.image}" alt="">` : ""}</div>
      <div class="pad">
        <div class="name">${String(p.name||"")}</div>
        <div class="muted small" style="margin-top:6px">${String(p.sku||"")} ‚Ä¢ ${String(p.brand||"")}</div>
        <div class="muted small" style="margin-top:6px">${String(p.short_desc||"")}</div>
        <div class="row" style="margin-top:10px;justify-content:space-between">
          <span class="pill">${fmtMoney(p.price || 0)}</span>
          <span class="pill">Stock: ${Number(p.stock||0)}</span>
        </div>
      </div>
    </a>
  `).join("");
}

async function homeLoad(){
  const q = $("q").value.trim();
  const category = $("category").value.trim();
  const brand = $("brand").value.trim();
  const sort = $("sort").value;

  if(q){
    const data = await apiGet({action:"search", q});
    if(!data.ok){ toast("L·ªói search"); return; }
    const items = data.items || [];
    state.total = items.length;
    $("countPill").textContent = `${items.length} s·∫£n ph·∫©m`;
    $("filterPill").textContent = `l·ªçc: q="${q}"`;
    $("pagePill").textContent = `Search`;
    renderGrid(items);
    return;
  }

  const params = {action:"list", page:state.page, limit:state.limit, sort};
  if(category) params.category = category;
  if(brand) params.brand = brand;

  const data = await apiGet(params);
  if(!data.ok){ toast("L·ªói list"); return; }

  state.total = data.total || 0;
  const maxPage = Math.max(1, Math.ceil(state.total / state.limit));
  $("countPill").textContent = `${state.total} s·∫£n ph·∫©m`;
  $("pagePill").textContent = `Trang ${state.page}/${maxPage}`;

  const f = [];
  if(category) f.push("cat=" + category);
  if(brand) f.push("brand=" + brand);
  $("filterPill").textContent = "l·ªçc: " + (f.length ? f.join(", ") : "none");

  renderGrid(data.items || []);
}

function prevPage(){ state.page = Math.max(1, state.page-1); homeLoad(); }
function nextPage(){
  const maxPage = Math.max(1, Math.ceil(state.total / state.limit));
  state.page = Math.min(maxPage, state.page+1);
  homeLoad();
}

/** =========================
 *  DETAIL
 *  ========================= */
async function loadRelated(p){
  const cat = (p.category||"").trim();
  let rel = [];
  if(cat){
    const data = await apiGet({action:"list", category:cat, page:1, limit:30, sort:"updated_desc"});
    if(data.ok) rel = (data.items||[]);
  }else{
    const data = await apiGet({action:"list", page:1, limit:30, sort:"updated_desc"});
    if(data.ok) rel = (data.items||[]);
  }
  rel = rel.filter(x=>x.slug !== p.slug);
  const sameBrand = rel.filter(x => (x.brand||"") === (p.brand||""));
  const mixed = [...sameBrand, ...rel.filter(x=> (x.brand||"") !== (p.brand||""))].slice(0,8);

  $("relGrid").innerHTML = mixed.map(x=>`
    <a class="card" href="#/p/${encodeURIComponent(x.slug)}">
      <div class="img">${x.image?`<img src="${x.image}">`:""}</div>
      <div class="pad">
        <div class="name">${String(x.name||"")}</div>
        <div class="muted small" style="margin-top:6px">${String(x.sku||"")}</div>
      </div>
    </a>
  `).join("");
}

async function loadDetail(slug){
  const data = await apiGet({action:"get", slug});
  if(!data.ok){ toast("Kh√¥ng t√¨m th·∫•y"); go("#/"); return; }

  const p = data.product;
  state.lastDetail = p;

  setMetaTitle(p.name || p.sku || "S·∫£n ph·∫©m");
  $("crumb").textContent = `Trang ch·ªß / ${p.category || "S·∫£n ph·∫©m"} / ${p.name || ""}`;

  $("d_name").textContent = p.name || "";
  $("d_status").textContent = (p.status || "active") === "hidden" ? "hidden" : "active";
  $("d_meta").textContent = `SKU: ${p.sku || ""} ‚Ä¢ Brand: ${p.brand || ""} ‚Ä¢ Category: ${p.category || ""}`;
  $("d_short").textContent = p.short_desc || "";
  $("d_price").textContent = `Gi√°: ${fmtMoney(p.price||0)}`;
  $("d_stock").textContent = `T·ªìn: ${Number(p.stock||0)}`;
  $("d_updated").textContent = `C·∫≠p nh·∫≠t: ${p.updated_at || "-"}`;

  const imgs = p.images || [];
  setHero(imgs[0]);
  $("thumbs").innerHTML = imgs.map(u=>`
    <div class="thumb" onclick="setHero('${String(u).replace(/'/g,"%27")}')"><img src="${u}" alt=""></div>
  `).join("");

  $("tab_desc").innerHTML = p.desc_html || `<p class="muted">Ch∆∞a c√≥ m√¥ t·∫£.</p>`;

  const specs = p.specs || {};
  const keys = Object.keys(specs || {});
  $("tab_spec").innerHTML = keys.length ? `
    <table>${keys.map(k=>`<tr><td>${k}</td><td>${specs[k]}</td></tr>`).join("")}</table>
  ` : `<p class="muted">Ch∆∞a c√≥ th√¥ng s·ªë.</p>`;

  await loadRelated(p);
}

function copyLink(){
  navigator.clipboard.writeText(location.href);
  toast("ƒê√£ copy link!");
}

/** tabs */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const k = t.dataset.tab;
    $("tab_desc").style.display = (k==="desc")?"block":"none";
    $("tab_spec").style.display = (k==="spec")?"block":"none";
    $("tab_rel").style.display = (k==="rel")?"block":"none";
  });
});

/** =========================
 *  ADMIN
 *  ========================= */
function adminLogin(){
  const token = $("adminToken").value.trim();
  if(!token){ toast("Nh·∫≠p token"); return; }
  state.adminToken = token;
  localStorage.setItem("ADMIN_TOKEN", token);
  $("adminState").textContent = "ƒë√£ l∆∞u token";
  toast("OK");
}
function adminLogout(){
  state.adminToken = "";
  localStorage.removeItem("ADMIN_TOKEN");
  $("adminState").textContent = "ch∆∞a ƒëƒÉng nh·∫≠p";
  toast("ƒê√£ logout");
}
function adminGetToken(){
  return state.adminToken || localStorage.getItem("ADMIN_TOKEN") || "";
}

let adminItems = [];

async function adminLoad(){
  const token = adminGetToken();
  if(!token){ toast("Ch∆∞a c√≥ token"); return; }
  const data = await apiGet({action:"admin_list", token});
  if(!data.ok){ toast("Sai token / l·ªói"); $("adminMsg").textContent = data.error||""; return; }
  adminItems = data.items || [];
  $("adminCount").textContent = `${adminItems.length} s·∫£n ph·∫©m`;
  renderAdminList(adminItems);
  $("adminMsg").textContent = "";
  toast("ƒê√£ t·∫£i");
}

function renderAdminList(items){
  const box = $("adminList");
  box.innerHTML = items.map(p=>`
    <div class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="name">${String(p.name||"")}</div>
            <div class="muted small">${String(p.sku||"")} ‚Ä¢ ${String(p.slug||"")} ‚Ä¢ ${String(p.status||"")}</div>
          </div>
          <div class="row">
            <button class="btn" onclick="editProduct('${p.id}')">‚úèÔ∏è</button>
            <button class="btn" onclick="go('#/p/${encodeURIComponent(p.slug)}')">üëÅ</button>
          </div>
        </div>
      </div>
    </div>
  `).join("");
}

$("adminFilter").addEventListener("input", ()=>{
  const q = $("adminFilter").value.trim().toLowerCase();
  const filtered = adminItems.filter(p=>{
    const hay = [p.name,p.sku,p.slug].map(x=>String(x||"").toLowerCase()).join(" | ");
    return !q || hay.includes(q);
  });
  $("adminCount").textContent = `${filtered.length} s·∫£n ph·∫©m`;
  renderAdminList(filtered);
});

function newForm(){
  $("f_id").value = "";
  $("f_status").value = "active";
  $("f_sku").value = "";
  $("f_name").value = "";
  $("f_slug").value = "";
  $("f_brand").value = "";
  $("f_category").value = "";
  $("f_tags").value = "";
  $("f_price").value = "0";
  $("f_stock").value = "0";
  $("f_images").value = "";
  $("f_short").value = "";
  $("f_desc").value = "";
  $("f_specs").value = "{}";
  $("adminMsg").textContent = "ƒêang t·∫°o m·ªõi...";
}

function editProduct(id){
  const p = adminItems.find(x=>String(x.id)===String(id));
  if(!p) return;
  $("f_id").value = p.id || "";
  $("f_status").value = p.status || "active";
  $("f_sku").value = p.sku || "";
  $("f_name").value = p.name || "";
  $("f_slug").value = p.slug || "";
  $("f_brand").value = p.brand || "";
  $("f_category").value = p.category || "";
  $("f_tags").value = p.tags || "";
  $("f_price").value = String(p.price || 0);
  $("f_stock").value = String(p.stock || 0);
  $("f_images").value = (p.images||[]).join("|");
  $("f_short").value = p.short_desc || "";
  $("f_desc").value = p.desc_html || "";
  $("f_specs").value = p.specs_json || "{}";
  $("adminMsg").textContent = "ƒêang s·ª≠a: " + (p.slug||"");
}

function readFormProduct(){
  return {
    id: $("f_id").value.trim(),
    status: $("f_status").value.trim() || "active",
    sku: $("f_sku").value.trim(),
    name: $("f_name").value.trim(),
    slug: $("f_slug").value.trim(),
    brand: $("f_brand").value.trim(),
    category: $("f_category").value.trim(),
    tags: $("f_tags").value.trim(),
    price: Number($("f_price").value || 0),
    stock: Number($("f_stock").value || 0),
    images: $("f_images").value.trim(),
    short_desc: $("f_short").value.trim(),
    desc_html: $("f_desc").value,
    specs_json: $("f_specs").value.trim() || "{}"
  };
}

async function saveProduct(){
  const token = adminGetToken();
  if(!token){ toast("Ch∆∞a c√≥ token"); return; }
  const product = readFormProduct();
  if(!product.sku || !product.name){ toast("Thi·∫øu SKU/T√™n"); return; }
  try{ JSON.parse(product.specs_json || "{}"); }catch(e){ toast("specs_json sai JSON"); return; }

  const data = await apiPost("upsert", token, {product});
  if(!data.ok){ toast("L·ªói l∆∞u"); $("adminMsg").textContent = data.error||""; return; }
  $("adminMsg").textContent = `OK: ${data.mode} ‚Ä¢ slug=${data.slug}`;
  toast("ƒê√£ l∆∞u");
  await adminLoad();
  if(data.slug) $("f_slug").value = data.slug;
}

async function deleteProduct(){
  const token = adminGetToken();
  if(!token){ toast("Ch∆∞a c√≥ token"); return; }
  const id = $("f_id").value.trim();
  const slug = $("f_slug").value.trim();
  if(!id && !slug){ toast("Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ x√≥a"); return; }

  const data = await apiGet({action:"delete", token, id, slug});
  if(!data.ok){ toast("L·ªói x√≥a"); $("adminMsg").textContent = data.error||""; return; }
  toast("ƒê√£ x√≥a");
  newForm();
  await adminLoad();
}

function previewProduct(){
  const slug = $("f_slug").value.trim();
  if(!slug){ toast("Ch∆∞a c√≥ slug"); return; }
  go("#/p/" + encodeURIComponent(slug));
}

/** =========================
 *  Upload image -> Drive (via API)
 *  ========================= */
$("imgUpload").addEventListener("change", async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;

  const token = adminGetToken();
  if(!token){ toast("Ch∆∞a c√≥ token"); return; }

  toast("ƒêang upload ·∫£nh...");
  const base64 = await fileToBase64Raw(file); // no data: prefix

  const data = await apiPost("upload_image", token, {
    filename: file.name,
    mimeType: file.type || "image/jpeg",
    base64
  });

  if(!data.ok){
    toast("Upload l·ªói");
    $("adminMsg").textContent = data.error || "";
    return;
  }

  const url = data.url;
  const cur = $("f_images").value.trim();
  $("f_images").value = cur ? (cur + "|" + url) : url;
  toast("Upload xong, ƒë√£ th√™m link");
  ev.target.value = "";
});

function fileToBase64Raw(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => {
      const s = String(r.result || "");
      // s: data:mime;base64,xxxx
      const idx = s.indexOf("base64,");
      resolve(idx >= 0 ? s.slice(idx + 7) : s);
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/** =========================
 *  Excel Export/Import
 *  ========================= */
function downloadTemplate(){
  const headers = [
    "id","slug","sku","name","brand","category","tags","short_desc","desc_html","specs_json",
    "images","price","stock","status"
  ];
  const ws = XLSX.utils.aoa_to_sheet([headers]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "template");
  XLSX.writeFile(wb, "products_template.xlsx");
}

function exportExcel(){
  if(!adminItems.length){ toast("Ch∆∞a c√≥ d·ªØ li·ªáu, h√£y t·∫£i danh s√°ch"); return; }
  const headers = [
    "id","slug","sku","name","brand","category","tags","short_desc","desc_html","specs_json",
    "images","price","stock","status","created_at","updated_at"
  ];
  const rows = adminItems.map(p=>[
    p.id||"", p.slug||"", p.sku||"", p.name||"", p.brand||"", p.category||"", p.tags||"",
    p.short_desc||"", p.desc_html||"", p.specs_json||"",
    (p.images||[]).join("|"), Number(p.price||0), Number(p.stock||0), p.status||"active",
    p.created_at||"", p.updated_at||""
  ]);
  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "products");
  XLSX.writeFile(wb, "products_export.xlsx");
}

$("importFile").addEventListener("change", async (ev)=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;

  const token = adminGetToken();
  if(!token){ toast("Ch∆∞a c√≥ token"); return; }

  try{
    toast("ƒêang ƒë·ªçc Excel...");
    const data = await readXlsx(file);

    // Take first sheet
    const sheetName = data.SheetNames[0];
    const ws = data.Sheets[sheetName];

    // Convert to JSON rows (header row)
    const rows = XLSX.utils.sheet_to_json(ws, {defval:"", raw:false});
    // Normalize keys
    const items = rows.map(r=>({
      id: String(r.id||"").trim(),
      slug: String(r.slug||"").trim(),
      sku: String(r.sku||"").trim(),
      name: String(r.name||"").trim(),
      brand: String(r.brand||"").trim(),
      category: String(r.category||"").trim(),
      tags: String(r.tags||"").trim(),
      short_desc: String(r.short_desc||"").trim(),
      desc_html: String(r.desc_html||""),
      specs_json: String(r.specs_json||"{}").trim() || "{}",
      images: String(r.images||"").trim(),
      price: Number(r.price||0),
      stock: Number(r.stock||0),
      status: String(r.status||"active").trim() || "active"
    }));

    toast("ƒêang import...");
    const res = await apiPost("batch_upsert", token, {items});
    if(!res.ok){
      toast("Import l·ªói");
      $("adminMsg").textContent = res.error || "";
      return;
    }
    $("adminMsg").textContent =
      `Import xong: created=${res.created}, updated=${res.updated}, skipped=${res.skipped}, errors=${(res.errors||[]).length}`;
    toast("Import OK");
    await adminLoad();
  }catch(err){
    toast("Import l·ªói");
    $("adminMsg").textContent = String(err);
  }finally{
    ev.target.value = "";
  }
});

function readXlsx(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = (e)=>{
      try{
        const u8 = new Uint8Array(e.target.result);
        const wb = XLSX.read(u8, {type:"array"});
        resolve(wb);
      }catch(err){ reject(err); }
    };
    r.onerror = reject;
    r.readAsArrayBuffer(file);
  });
}

/** =========================
 *  ROUTER
 *  ========================= */
function show(route){
  $("route_home").classList.toggle("hide", route!=="home");
  $("route_detail").classList.toggle("hide", route!=="detail");
  $("route_admin").classList.toggle("hide", route!=="admin");
  $("envPill").textContent = route;
}

async function route(){
  const h = location.hash || "#/";
  const parts = h.replace(/^#\//,"").split("/").filter(Boolean);

  if(parts.length===0){
    show("home");
    setMetaTitle("");
    state.page = 1;
    await homeBootstrapFilters();
    await homeLoad();
    return;
  }

  if(parts[0]==="p" && parts[1]){
    show("detail");
    const slug = decodeURIComponent(parts.slice(1).join("/"));
    await loadDetail(slug);
    return;
  }

  if(parts[0]==="admin"){
    show("admin");
    $("adminToken").value = state.adminToken || localStorage.getItem("ADMIN_TOKEN") || "";
    $("adminState").textContent = $("adminToken").value ? "ƒë√£ c√≥ token (local)" : "ch∆∞a ƒëƒÉng nh·∫≠p";
    return;
  }

  go("#/");
}

window.addEventListener("hashchange", route);

let homeTimer;
["q","category","brand","sort"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    clearTimeout(homeTimer);
    homeTimer = setTimeout(()=>{ state.page=1; homeLoad(); }, 260);
  });
  $(id).addEventListener("change", ()=>{
    state.page=1; homeLoad();
  });
});

(async function start(){
  await loadSite();
  route();
})();
</script>
</body>
</html>
